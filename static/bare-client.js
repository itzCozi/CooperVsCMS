!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).BareClient=t()}(this,function(){"use strict";let e=globalThis.fetch,t=globalThis.WebSocket,s=globalThis.Request,a=globalThis.Response,r=[101,204,205,304],n=[301,302,303,307,308];class o extends Error{status;body;constructor(e,t){super(t.message||t.code),this.status=e,this.body=t}}class i{base;constructor(e,t){this.base=new URL(`./v${e}/`,t)}}let h="!#$%&'*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`abcdefghijklmnopqrstuvwxyz|~";function c(e){for(let t=0;t<e.length;t++){let s=e[t];if(!h.includes(s))return!1}return!0}function _(e,t){let s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function l(e,t,s,a,r,n){var o,i;return _((o=_(_(t,e),_(a,n)),o<<(i=r)|o>>>32-i),s)}function d(e,t,s,a,r,n,o){return l(t&s|~t&a,e,t,r,n,o)}function f(e,t,s,a,r,n,o){return l(t&a|s&~a,e,t,r,n,o)}function $(e,t,s,a,r,n,o){return l(t^s^a,e,t,r,n,o)}function w(e,t,s,a,r,n,o){return l(s^(t|~a),e,t,r,n,o)}function u(e,t){e[t>>5]|=128<<t%32,e[(t+64>>>9<<4)+14]=t;let s=1732584193,a=-271733879,r=-1732584194,n=271733878;for(let o=0;o<e.length;o+=16){let i=s,h=a,c=r,l=n;s=d(s,a,r,n,e[o],7,-680876936),n=d(n,s,a,r,e[o+1],12,-389564586),r=d(r,n,s,a,e[o+2],17,606105819),a=d(a,r,n,s,e[o+3],22,-1044525330),s=d(s,a,r,n,e[o+4],7,-176418897),n=d(n,s,a,r,e[o+5],12,1200080426),r=d(r,n,s,a,e[o+6],17,-1473231341),a=d(a,r,n,s,e[o+7],22,-45705983),s=d(s,a,r,n,e[o+8],7,1770035416),n=d(n,s,a,r,e[o+9],12,-1958414417),r=d(r,n,s,a,e[o+10],17,-42063),a=d(a,r,n,s,e[o+11],22,-1990404162),s=d(s,a,r,n,e[o+12],7,1804603682),n=d(n,s,a,r,e[o+13],12,-40341101),r=d(r,n,s,a,e[o+14],17,-1502002290),a=d(a,r,n,s,e[o+15],22,1236535329),s=f(s,a,r,n,e[o+1],5,-165796510),n=f(n,s,a,r,e[o+6],9,-1069501632),r=f(r,n,s,a,e[o+11],14,643717713),a=f(a,r,n,s,e[o],20,-373897302),s=f(s,a,r,n,e[o+5],5,-701558691),n=f(n,s,a,r,e[o+10],9,38016083),r=f(r,n,s,a,e[o+15],14,-660478335),a=f(a,r,n,s,e[o+4],20,-405537848),s=f(s,a,r,n,e[o+9],5,568446438),n=f(n,s,a,r,e[o+14],9,-1019803690),r=f(r,n,s,a,e[o+3],14,-187363961),a=f(a,r,n,s,e[o+8],20,1163531501),s=f(s,a,r,n,e[o+13],5,-1444681467),n=f(n,s,a,r,e[o+2],9,-51403784),r=f(r,n,s,a,e[o+7],14,1735328473),a=f(a,r,n,s,e[o+12],20,-1926607734),s=$(s,a,r,n,e[o+5],4,-378558),n=$(n,s,a,r,e[o+8],11,-2022574463),r=$(r,n,s,a,e[o+11],16,1839030562),a=$(a,r,n,s,e[o+14],23,-35309556),s=$(s,a,r,n,e[o+1],4,-1530992060),n=$(n,s,a,r,e[o+4],11,1272893353),r=$(r,n,s,a,e[o+7],16,-155497632),a=$(a,r,n,s,e[o+10],23,-1094730640),s=$(s,a,r,n,e[o+13],4,681279174),n=$(n,s,a,r,e[o],11,-358537222),r=$(r,n,s,a,e[o+3],16,-722521979),a=$(a,r,n,s,e[o+6],23,76029189),s=$(s,a,r,n,e[o+9],4,-640364487),n=$(n,s,a,r,e[o+12],11,-421815835),r=$(r,n,s,a,e[o+15],16,530742520),a=$(a,r,n,s,e[o+2],23,-995338651),s=w(s,a,r,n,e[o],6,-198630844),n=w(n,s,a,r,e[o+7],10,1126891415),r=w(r,n,s,a,e[o+14],15,-1416354905),a=w(a,r,n,s,e[o+5],21,-57434055),s=w(s,a,r,n,e[o+12],6,1700485571),n=w(n,s,a,r,e[o+3],10,-1894986606),r=w(r,n,s,a,e[o+10],15,-1051523),a=w(a,r,n,s,e[o+1],21,-2054922799),s=w(s,a,r,n,e[o+8],6,1873313359),n=w(n,s,a,r,e[o+15],10,-30611744),r=w(r,n,s,a,e[o+6],15,-1560198380),a=w(a,r,n,s,e[o+13],21,1309151649),s=w(s,a,r,n,e[o+4],6,-145523070),n=w(n,s,a,r,e[o+11],10,-1120210379),r=w(r,n,s,a,e[o+2],15,718787259),a=w(a,r,n,s,e[o+9],21,-343485551),s=_(s,i),a=_(a,h),r=_(r,c),n=_(n,l)}return[s,a,r,n]}function b(e){let t="",s=32*e.length;for(let a=0;a<s;a+=8)t+=String.fromCharCode(e[a>>5]>>>a%32&255);return t}function p(e){let t=[],s=e.length>>2;for(let a=0;a<s;a+=1)t[a]=0;let r=8*e.length;for(let n=0;n<r;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}function g(e){let t="0123456789abcdef",s="";for(let a=0;a<e.length;a+=1){let r=e.charCodeAt(a);s+=t.charAt(r>>>4&15)+t.charAt(15&r)}return s}function x(e){return unescape(encodeURIComponent(e))}function m(e){var t;return b(u(p(t=x(e)),8*t.length))}function y(e,t){return function e(t,s){let a=p(t),r=[],n=[];a.length>16&&(a=u(a,8*t.length));for(let o=0;o<16;o+=1)r[o]=909522486^a[o],n[o]=1549556828^a[o];let i=u(r.concat(p(s)),512+8*s.length);return b(u(n.concat(i),640))}(x(e),x(t))}let v=[["v2",class n extends i{ws;http;newMeta;getMeta;constructor(e){super(2,e),this.ws=new URL(this.base),this.http=new URL(this.base),this.newMeta=new URL("./ws-new-meta",this.base),this.getMeta=new URL("./ws-meta",this.base),"https:"===this.ws.protocol?this.ws.protocol="wss:":this.ws.protocol="ws:"}async connect(a,r,n,i,h){let c=new s(this.newMeta,{headers:this.createBareHeaders(r,n,h,i,a)}),_=await e(c);if(!_.ok)throw new o(_.status,await _.json());let l=await _.text(),d=new t(this.ws,[l,]);return d.meta=new Promise((t,s)=>{d.addEventListener("open",async()=>{let s=await e(this.getMeta,{headers:{"x-bare-id":l},method:"GET"});t(await await this.readBareResponse(s))}),d.addEventListener("error",s)}),d}async request(t,n,o,i,h,c,_,l,d){if(i.startsWith("blob:")){let f=await e(`blob:${location.origin}${_}`),$=new a(f.body,f);return $.rawHeaders=Object.fromEntries(f.headers),$.rawResponse=f,$}let w={};if(n instanceof Headers)for(let[u,b]of n)w[u]=b;else for(let p in n)w[p]=n[p];let x={credentials:"omit",method:t,signal:d};"only-if-cached"!==l&&(x.cache=l),void 0!==o&&(x.body=o),x.headers=this.createBareHeaders(i,h,_,c,w);let v=new s(this.http+"?cache="+function e(t,s,a){var r,n,o;if(!s)return a?m(t):g(m(r=t));return a?y(s,t):(n=s,g(y(n,o=t)))}(`${i}${h}${c}${_}`),x),k=await e(v),E=await this.readBareResponse(k),R=new a(r.includes(E.status)?void 0:k.body,{status:E.status,statusText:E.statusText??void 0,headers:E.headers});return R.rawHeaders=E.rawHeaders,R.rawResponse=k,R}async readBareResponse(e){if(!e.ok)throw new o(e.status,await e.json());let t=function e(t){let s=new Headers(t),a="x-bare-headers";if(t.has(`${a}-0`)){let r=[];for(let[n,i]of t){if(!n.startsWith(a))continue;if(!i.startsWith(";"))throw new o(400,{code:"INVALID_BARE_HEADER",id:`request.headers.${n}`,message:"Value didn't begin with semi-colon."});let h=parseInt(n.slice(a.length+1));r[h]=i.slice(1),s.delete(n)}s.set(a,r.join(""))}return s}(e.headers),s={};return t.has("x-bare-status")&&(s.status=parseInt(t.get("x-bare-status"))),t.has("x-bare-status-text")&&(s.statusText=t.get("x-bare-status-text")),t.has("x-bare-headers")&&(s.rawHeaders=JSON.parse(t.get("x-bare-headers")),s.headers=new Headers(s.rawHeaders)),s}createBareHeaders(e,t,s,a,r,n=[],o=[],i=[]){let h=new Headers;for(let c of(h.set("x-bare-protocol",e),h.set("x-bare-host",t),h.set("x-bare-path",s),h.set("x-bare-port",a.toString()),h.set("x-bare-headers",JSON.stringify(r)),n))h.append("x-bare-forward-headers",c);for(let _ of o)h.append("x-bare-pass-headers",_);for(let l of i)h.append("x-bare-pass-status",l.toString());return!function e(t){let s=new Headers(t);if(t.has("x-bare-headers")){let a=t.get("x-bare-headers");if(a.length>3072){s.delete("x-bare-headers");let r=0;for(let n=0;n<a.length;n+=3072){let o=a.slice(n,n+3072),i=r++;s.set(`x-bare-headers-${i}`,`;${o}`)}}}return s}(h),h}}],["v1",class n extends i{ws;http;newMeta;getMeta;constructor(e){super(1,e),this.ws=new URL(this.base),this.http=new URL(this.base),this.newMeta=new URL("ws-new-meta",this.base),this.getMeta=new URL("ws-meta",this.base),"https:"===this.ws.protocol?this.ws.protocol="wss:":this.ws.protocol="ws:"}async connect(s,a,r,n,i){let c=await e(this.newMeta,{method:"GET"});if(!c.ok)throw new o(c.status,await c.json());let _=await c.text(),l=new t(this.ws,["bare",function e(t){let s="";for(let a=0;a<t.length;a++){let r=t[a];if(h.includes(r)&&"%"!==r)s+=r;else{let n=r.charCodeAt(0);s+="%"+n.toString(16).padStart(2,"0")}}return s}(JSON.stringify({remote:{protocol:a,host:r,port:n,path:i},headers:s,forward_headers:["accept-encoding","accept-language","sec-websocket-extensions","sec-websocket-key","sec-websocket-version",],id:_})),]);return l.meta=new Promise((t,s)=>{l.addEventListener("open",async()=>{let a=await e(this.getMeta,{headers:{"x-bare-id":_},method:"GET"});a.ok||s(new o(a.status,await a.json())),t(await a.json())}),l.addEventListener("error",s)}),l}async request(t,n,o,i,h,c,_,l,d){if(i.startsWith("blob:")){let f=await e(`blob:${location.origin}${_}`),$=new a(f.body,f);return $.rawHeaders=Object.fromEntries(f.headers),$.rawResponse=f,$}let w={};if(n instanceof Headers)for(let[u,b]of n)w[u]=b;else for(let p in n)w[p]=n[p];let g={credentials:"omit",method:t,signal:d};void 0!==o&&(g.body=o);let x=new s(this.http,g);this.writeBareRequest(x,i,h,_,c,w,["accept-encoding","accept-language"]);let m=await e(x),y=await this.readBareResponse(m),v=new a(r.includes(y.status)?void 0:m.body,{status:y.status,statusText:y.statusText??void 0,headers:y.headers});return v.rawHeaders=y.rawHeaders,v.rawResponse=m,v}async readBareResponse(e){if(!e.ok)throw new o(e.status,await e.json());for(let t of["x-bare-status","x-bare-status-text","x-bare-headers",])if(!e.headers.has(t))throw new o(500,{code:"IMPL_MISSING_BARE_HEADER",id:`response.headers.${t}`});let s=parseInt(e.headers.get("x-bare-status")),a=e.headers.get("x-bare-status-text"),r=JSON.parse(e.headers.get("x-bare-headers")),n=new Headers(r);return{status:s,statusText:a,rawHeaders:r,headers:n}}writeBareRequest(e,t,s,a,r,n,o){e.headers.set("x-bare-protocol",t),e.headers.set("x-bare-host",s),e.headers.set("x-bare-path",a),e.headers.set("x-bare-port",r.toString()),e.headers.set("x-bare-headers",JSON.stringify(n)),e.headers.set("x-bare-forward-headers",JSON.stringify(o))}}],];async function k(t,s){let a=await e(t,{signal:s});if(!a.ok)throw Error(`Unable to fetch Bare meta: ${a.status} ${await a.text()}`);return await a.json()}class E{get data(){return this.manfiest}manfiest;client;server;working;onDemand;onDemandSignal;constructor(e,t){this.server=new URL(e),!t||t instanceof AbortSignal?(this.onDemand=!0,this.onDemandSignal=t):(this.onDemand=!1,this.manfiest=t,this.getClient())}demand(){if(this.onDemand)return this.working||(this.working=k(this.server,this.onDemandSignal).then(e=>{this.manfiest=e,this.getClient()})),this.working}getClient(){for(let[e,t]of v)if(this.data.versions.includes(e)){this.client=new t(this.server);return}throw Error("Unable to find compatible client version.")}async request(e,t,s,a,r,n,o,i,h){return await this.demand(),await this.client.request(e,t,s,a,r,n,o,i,h)}async connect(e,t,s,a,r){return await this.demand(),this.client.connect(e,t,s,a,r)}createWebSocket(e,t={},s=[]){let a=t instanceof Headers?Object.fromEntries(t):t;for(let r of(e=new URL(e),a.Host=e.host,a.Pragma="no-cache",a["Cache-Control"]="no-cache",a.Upgrade="websocket",a.Connection="Upgrade","string"==typeof s&&(s=[s]),s))if(!c(r))throw new DOMException(`Failed to construct 'WebSocket': The subprotocol '${r}' is invalid.`);return s.length&&(t["Sec-Websocket-Protocol"]=s.join(", ")),this.connect(t,e.protocol,e.hostname,e.port,e.pathname+e.search)}async fetch(e,t={}){e instanceof s?(t||(t=e),e=new URL(e.url)):e=new URL(e);let a;a="string"==typeof t.method?t.method:"GET";let r;void 0!==t.body&&null!==t.body&&(r=t.body);let o;o="object"==typeof t.headers&&null!==t.headers?t.headers instanceof Headers?Object.fromEntries(t.headers):t.headers:{};let i;i="string"==typeof t.cache?t.cache:"default";let h;t.signal instanceof AbortSignal&&(h=t.signal);for(let c=0;;c++){let _;_=""===e.port?"https:"===e.protocol?"443":"80":e.port,o.host=e.host;let l=await this.request(a,o,r,e.protocol,e.hostname,_,e.pathname+e.search,i,h);if(l.finalURL=e.toString(),!n.includes(l.status))return l;switch(t.redirect){default:case"follow":if(20>c&&l.headers.has("location")){e=new URL(l.headers.get("location"),e);continue}throw TypeError("Failed to fetch");case"error":throw TypeError("Failed to fetch");case"manual":return l}}}}async function R(e,t){let s=await k(e,t);return new E(e,s)}return E});