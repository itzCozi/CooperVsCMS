importScripts("/uv/uv.bundle.js"),importScripts("/uv/uv.config.js");class UVServiceWorker extends EventEmitter{constructor(e=__uv$config){super(),e.bare||(e.bare="/bare/"),this.addresses="string"==typeof e.bare?[new URL(e.bare,location)]:e.bare.map(e=>new URL(e,location)),this.headers={csp:["cross-origin-embedder-policy","cross-origin-opener-policy","cross-origin-resource-policy","content-security-policy","content-security-policy-report-only","expect-ct","feature-policy","origin-isolation","strict-transport-security","upgrade-insecure-requests","x-content-type-options","x-download-options","x-frame-options","x-permitted-cross-domain-policies","x-powered-by","x-xss-protection",],forward:["accept-encoding","connection","content-length",]},this.method={empty:["GET","HEAD"]},this.statusCode={empty:[204,304,]},this.config=e,this.browser=Ultraviolet.Bowser.getParser(self.navigator.userAgent).getBrowserName(),"Firefox"===this.browser&&(this.headers.forward.push("user-agent"),this.headers.forward.push("content-type"))}async fetch({request:e}){if(!e.url.startsWith(location.origin+(this.config.prefix||"/service/")))return fetch(e);try{let t=new Ultraviolet(this.config);"function"==typeof this.config.construct&&this.config.construct(t,"service");let r=await t.cookie.db();t.meta.origin=location.origin,t.meta.base=t.meta.url=new URL(t.sourceUrl(e.url));let n=new RequestContext(e,this,t,this.method.empty.includes(e.method.toUpperCase())?null:await e.blob());if("blob:"===t.meta.url.protocol&&(n.blob=!0,n.base=n.url=new URL(n.url.pathname)),e.referrer&&e.referrer.startsWith(location.origin)){let i=new URL(t.sourceUrl(e.referrer));(n.headers.origin||t.meta.url.origin!==i.origin&&"cors"===e.mode)&&(n.headers.origin=i.origin),n.headers.referer=i.href}let s=await t.cookie.getCookies(r)||[],o=t.cookie.serialize(s,t.meta,!1);"Firefox"!==this.browser||"iframe"===e.destination||"document"===e.destination||n.forward.shift(),o&&(n.headers.cookie=o),n.headers.Host=n.url.host;let a=new HookEvent(n,null,null);if(this.emit("request",a),a.intercepted)return a.returnValue;let u=await fetch(n.send);if(500===u.status)return Promise.reject("");let l=new ResponseContext(n,u,this),h=new HookEvent(l,null,null);if(this.emit("beforemod",h),h.intercepted)return h.returnValue;for(let c of this.headers.csp)l.headers[c]&&delete l.headers[c];if(l.headers.location&&(l.headers.location=t.rewriteUrl(l.headers.location)),l.headers["set-cookie"]&&(Promise.resolve(t.cookie.setCookies(l.headers["set-cookie"],r,t.meta)).then(()=>{self.clients.matchAll().then(function(e){e.forEach(function(e){e.postMessage({msg:"updateCookies",url:t.meta.url.href})})})}),delete l.headers["set-cookie"]),l.body)switch(e.destination){case"script":case"worker":l.body=`if (!self.__uv && self.importScripts) importScripts('${__uv$config.bundle}', '${__uv$config.config}', '${__uv$config.handler}');
`,l.body+=t.js.rewrite(await u.text());break;case"style":l.body=t.rewriteCSS(await u.text());break;case"iframe":case"document":isHtml(t.meta.url,l.headers["content-type"]||"")&&(l.body=t.rewriteHtml(await u.text(),{document:!0,injectHead:t.createHtmlInject(this.config.handler,this.config.bundle,this.config.config,t.cookie.serialize(s,t.meta,!0),e.referrer)}))}if("text/event-stream"===n.headers.accept&&(l.headers["content-type"]="text/event-stream"),this.emit("response",h),h.intercepted)return h.returnValue;return new Response(l.body,{headers:l.headers,status:l.status,statusText:l.statusText})}catch(d){return new Response(d.toString(),{status:500})}}getBarerResponse(e){let t={},r=JSON.parse(e.headers.get("x-bare-headers"));for(let n in r)t[n.toLowerCase()]=r[n];return{headers:t,status:+e.headers.get("x-bare-status"),statusText:e.headers.get("x-bare-status-text"),body:this.statusCode.empty.includes(+e.headers.get("x-bare-status"))?null:e.body}}get address(){return this.addresses[Math.floor(Math.random()*this.addresses.length)]}static Ultraviolet=Ultraviolet}self.UVServiceWorker=UVServiceWorker;class ResponseContext{constructor(e,t,r){let{headers:n,status:i,statusText:s,body:o}=e.blob?{status:t.status,statusText:t.statusText,headers:Object.fromEntries([...t.headers.entries()]),body:t.body}:r.getBarerResponse(t);this.request=e,this.raw=t,this.ultraviolet=e.ultraviolet,this.headers=n,this.status=i,this.statusText=s,this.body=o}get url(){return this.request.url}get base(){return this.request.base}set base(e){this.request.base=e}}class RequestContext{constructor(e,t,r,n=null){this.ultraviolet=r,this.request=e,this.headers=Object.fromEntries([...e.headers.entries()]),this.method=e.method,this.forward=[...t.headers.forward],this.address=t.address,this.body=n||null,this.redirect=e.redirect,this.credentials="omit",this.mode="cors"===e.mode?e.mode:"same-origin",this.blob=!1}get send(){return new Request(this.blob?"blob:"+location.origin+this.url.pathname:this.address.href+"v1/",{method:this.method,headers:{"x-bare-protocol":this.url.protocol,"x-bare-host":this.url.hostname,"x-bare-path":this.url.pathname+this.url.search,"x-bare-port":this.url.port||("https:"===this.url.protocol?"443":"80"),"x-bare-headers":JSON.stringify(this.headers),"x-bare-forward-headers":JSON.stringify(this.forward)},redirect:this.redirect,credentials:this.credentials,mode:location.origin!==this.address.origin?"cors":this.mode,body:this.body})}get url(){return this.ultraviolet.meta.url}set url(e){this.ultraviolet.meta.url=e}get base(){return this.ultraviolet.meta.base}set base(e){this.ultraviolet.meta.base=e}}function isHtml(e,t=""){return"text/html"===(Ultraviolet.mime.contentType(t||e.pathname)||"text/html").split(";")[0]}class HookEvent{#a;#b;constructor(e={},t=null,r=null){this.#a=!1,this.#b=null,this.data=e,this.target=t,this.that=r}get intercepted(){return this.#a}get returnValue(){return this.#b}respondWith(e){this.#b=e,this.#a=!0}}var ReflectOwnKeys,R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function e(t,r,n){return Function.prototype.apply.call(t,r,n)};function ProcessEmitWarning(e){console&&console.warn&&console.warn(e)}ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function e(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function e(t){return Object.getOwnPropertyNames(t)};var NumberIsNaN=Number.isNaN||function e(t){return t!=t};function EventEmitter(){EventEmitter.init.call(this)}EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(e){if("function"!=typeof e)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function _getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function _addListener(e,t,r,n){if(checkListener(r),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),o=s[t]),void 0===o)o=s[t]=r,++e._eventsCount;else if("function"==typeof o?o=s[t]=n?[r,o]:[o,r]:n?o.unshift(r):o.push(r),(i=_getMaxListeners(e))>0&&o.length>i&&!o.warned){o.warned=!0;var i,s,o,a=Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,ProcessEmitWarning(a)}return e}function onceWrapper(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=onceWrapper.bind(n);return i.listener=r,n.wrapFn=i,i}function _listeners(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?unwrapListeners(i):arrayClone(i,i.length)}function listenerCount(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function arrayClone(e,t){for(var r=Array(t),n=0;n<t;++n)r[n]=e[n];return r}function spliceOne(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function unwrapListeners(e){for(var t=Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function once(e,t){return new Promise(function(r,n){function i(r){e.removeListener(t,s),n(r)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}eventTargetAgnosticAddListener(e,t,s,{once:!0}),"error"!==t&&addErrorHandlerIfEventEmitter(e,i,{once:!0})})}function addErrorHandlerIfEventEmitter(e,t,r){"function"==typeof e.on&&eventTargetAgnosticAddListener(e,"error",t,r)}function eventTargetAgnosticAddListener(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else if("function"==typeof e.addEventListener)e.addEventListener(t,function i(s){n.once&&e.removeEventListener(t,i),r(s)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if("number"!=typeof e||e<0||NumberIsNaN(e))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");defaultMaxListeners=e}}),EventEmitter.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function e(t){if("number"!=typeof t||t<0||NumberIsNaN(t))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},EventEmitter.prototype.getMaxListeners=function e(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function e(t){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);var i="error"===t,s=this._events;if(void 0!==s)i=i&&void 0===s.error;else if(!i)return!1;if(i){if(r.length>0&&(o=r[0]),o instanceof Error)throw o;var o,a=Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var u=s[t];if(void 0===u)return!1;if("function"==typeof u)ReflectApply(u,this,r);else for(var l=u.length,h=arrayClone(u,l),n=0;n<l;++n)ReflectApply(h[n],this,r);return!0},EventEmitter.prototype.addListener=function e(t,r){return _addListener(this,t,r,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function e(t,r){return _addListener(this,t,r,!0)},EventEmitter.prototype.once=function e(t,r){return checkListener(r),this.on(t,_onceWrap(this,t,r)),this},EventEmitter.prototype.prependOnceListener=function e(t,r){return checkListener(r),this.prependListener(t,_onceWrap(this,t,r)),this},EventEmitter.prototype.removeListener=function e(t,r){var n,i,s,o,a;if(checkListener(r),void 0===(i=this._events)||void 0===(n=i[t]))return this;if(n===r||n.listener===r)0==--this._eventsCount?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||r));else if("function"!=typeof n){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===r||n[o].listener===r){a=n[o].listener,s=o;break}if(s<0)return this;0===s?n.shift():spliceOne(n,s),1===n.length&&(i[t]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",t,a||r)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function e(t){var r,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){var s,o=Object.keys(n);for(i=0;i<o.length;++i)"removeListener"!==(s=o[i])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(r=n[t]))this.removeListener(t,r);else if(void 0!==r)for(i=r.length-1;i>=0;i--)this.removeListener(t,r[i]);return this},EventEmitter.prototype.listeners=function e(t){return _listeners(this,t,!0)},EventEmitter.prototype.rawListeners=function e(t){return _listeners(this,t,!1)},EventEmitter.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function e(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};